<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>â—ğŸ”„ Silence evaluation errors during selection - Const Generics Project Group</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../skill-tree.css">
        <link rel="stylesheet" href="../skill-tree-finetuning.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html">ğŸ‘‹ğŸ½ Welcome</a></li><li class="chapter-item expanded "><a href="../CHARTER.html">ğŸ“œ Charter</a></li><li class="chapter-item expanded "><a href="../vision.html">ğŸ”® The vision</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../vision/why-compile-time-evaluation.html">ğŸ¤” Why compile time evaluation</a></li><li class="chapter-item expanded "><a href="../vision/characters.html">ğŸ™‹â€â™€ï¸ Cast of characters</a></li><li class="chapter-item expanded "><a href="../skill-tree.html">ğŸ”€ Skill Tree</a></li><li class="chapter-item expanded "><a href="../vision/status_quo.html">ğŸ˜± Status quo</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../vision/status_quo/array_default.html">Array defaults</a></li><li class="chapter-item expanded "><a href="../vision/status_quo/split_first.html">Array split first method</a></li><li class="chapter-item expanded "><a href="../vision/status_quo/nalgebra.html">nalgebra</a></li></ol></li><li class="chapter-item expanded "><a href="../vision/shiny_future.html">âœ¨ Shiny future</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../vision/shiny_future/array_default.html">Array defaults</a></li><li class="chapter-item expanded "><a href="../vision/shiny_future/split_first.html">Array split first method</a></li><li class="chapter-item expanded "><a href="../vision/shiny_future/image_type.html">Image type in rust-gpu</a></li></ol></li><li class="chapter-item expanded "><a href="../vision/roadmap.html">ğŸ“… Roadmap for 2021</a></li><li class="chapter-item expanded "><a href="../vision/how_to_vision_doc.html">â“How to vision doc</a></li></ol></li><li class="chapter-item expanded "><a href="../meetings/index.html">ğŸ” Meetings</a></li><li class="chapter-item expanded "><a href="../design/index.html">ğŸ“š Design</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../design/constraining-generic-parameters.html">â— Constraining generic parameters</a></li><li class="chapter-item expanded "><a href="../design/generic-const-param-types.html">â—âš–ï¸ğŸ”„ Generic const parameter types</a></li><li class="chapter-item expanded "><a href="../design/leaking-implementation-details.html">â—ğŸ”™ Leaking implementation details</a></li><li class="chapter-item expanded "><a href="../design/opaque-and-transparent-assoc-consts.html">â—ğŸ”™ Opaque and transparent associated constants</a></li><li class="chapter-item expanded "><a href="../design/const-eval-requirements.html">â—ğŸ”™ Restrictions on const evaluation</a></li><li class="chapter-item expanded "><a href="../design/eval-errors-during-selection.html" class="active">â—ğŸ”„ Silence evaluation errors during selection</a></li><li class="chapter-item expanded "><a href="../design/structural-equality.html">â—ğŸ”™ âš–ï¸ Structural equality</a></li><li class="chapter-item expanded "><a href="../design/unused-substs.html">â—ğŸ”™ ğŸ”„ Unused substs</a></li><li class="chapter-item expanded "><a href="../design/valid-const-parameter-types.html">â—âš–ï¸ Valid const parameter types</a></li><li class="chapter-item expanded "><a href="../design/valtrees.html">â— Valtrees</a></li><li class="chapter-item expanded "><a href="../design/exhaustiveness.html">â” Exhaustiveness</a></li><li class="chapter-item expanded "><a href="../design/functions-as-const-parameters.html">â”ğŸ”™ Functions as const parameters</a></li></ol></li><li class="chapter-item expanded "><a href="../draft-rfcs/index.html">âœï¸ Draft RFCs</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Const Generics Project Group</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/project-const-generics" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="-silence-evaluation-errors-during-selection"><a class="header" href="#-silence-evaluation-errors-during-selection">â—ğŸ”„ Silence evaluation errors during selection</a></h1>
<p>Given an impl like</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>trait Trait&lt;const N: usize&gt; {
    type Assoc;
}
impl&lt;const N: usize&gt; Trait&lt;N&gt; for [u8; N - 1] {
    type Assoc = u32;
}
impl&lt;const N: usize&gt; Trait&lt;0&gt; for [u8; 0] {
    type Assoc = u64;
}
<span class="boring">}
</span></code></pre></pre>
<p>This would cause an error during coherence because we fail to evaluate <code>N - 1</code> when using <code>0</code> for <code>N</code>.</p>
<h3 id="can-we-avoid-silent-ctfe-errors"><a class="header" href="#can-we-avoid-silent-ctfe-errors">Can we avoid silent CTFE errors?</a></h3>
<p><strong>tl;dr: no</strong></p>
<p>Changing CTFE to potentially not emit errors is not ideal and could be a new source of bugs.
Everything else being equal, we should avoid this.</p>
<p>Instead of using const evaluation failures to discard candidates, we could instead use conditions,
rewriting the above example to</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct Condition&lt;const B: bool&gt;;
trait IsTrue {}
impl IsTrue for Condition&lt;true&gt; {}

trait Trait&lt;const N: usize&gt; {
    type Assoc;
}
impl&lt;const N: usize&gt; Trait&lt;N&gt; for [u8; N - 1]
where
    Condition&lt;{ N &gt; 0 }: IsTrue,
{
    type Assoc = u32;
}
impl&lt;const N: usize&gt; Trait&lt;0&gt; for [u8; 0] {
    type Assoc = u64;
}
<span class="boring">}
</span></code></pre></pre>
<p>This would make it difficult for the compiler to check that these impls are <a href="./exhaustiveness.html">exhaustive</a>
if that is something we want to add. <strong>TODO: this isn't necessarily true, elaborate here</strong></p>
<p>It also might not even be enough to avoid incorrect errors during candidate selection.
We start candidate selection by trying to unify the the <code>TraitRef</code>s of the impl and the obligation.
Checking whether <code>[u8; 0]: Trait&lt;N&gt;</code> holds therefore tries to unify <code>[u8; ?0 - 1]: Trait&lt;?0&gt;</code> with <code>[u8; 0]: Trait&lt;0&gt;</code>
which - unless we explicitly avoid it - will cause us to evaluate <code>0 - 1</code> and emit an error. </p>
<p>This issue is also prevalent for generic constants in <code>where</code>-clauses.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>trait Foo {}
impl&lt;const N: usize&gt; Foo for [u8; N]
where
    Condition&lt;{ N &gt; 0 }&gt;: IsTrue,
    [u8; N - 1]: Foo,
{}
<span class="boring">}
</span></code></pre></pre>
<p>We would have to somehow force the compiler to first check <code>Condition&lt;{ N &gt; 0 }&gt;: IsTrue</code> before checking <code>[u8; N - 1]: Foo</code>.
While we could add some special predicate kind for &quot;this has to evaluate to <code>true</code>&quot;, we still have the same issue in case
we have multiple such bounds which some dependencies between them. Another option would be to check predicates in a defined order,
e.g. in order of appearance. That is difficult to fit into the current query system and opens up a lot of difficult questions.</p>
<p><strong>TODO</strong>: Refer to cyclic dependencies in where clauses here, that would also theoreticall be solved by relying on a syntactic order
and should go more in-depth than this.</p>
<p>We therefore believe that the option for CTFE errors to be silent is needed.</p>
<h3 id="undefined-behavior-during-ctfe"><a class="header" href="#undefined-behavior-during-ctfe">Undefined behavior during CTFE</a></h3>
<p>Whether the compiler detects undefined behavior during const evaluation is not part
of our stability guarantees, so we <strong>must not</strong> consider some candidate to not apply due to UB by itself.</p>
<p>We can therefore either only error if the impl would apply unless UB were to occur or always emit an error.
Always emitting an error when encountering UB seems desirable, even if it happens during selection.</p>
<h3 id="reaching-const_eval_limit"><a class="header" href="#reaching-const_eval_limit">Reaching <code>#[const_eval_limit]</code></a></h3>
<p>When reaching the interpreter step limit, e.g. by using <code>loop {}</code>, it is unclear whether the code
would compile after some additional steps. We therefore have to treat this in the same way as UB.
Unlike UB, rejecting a candidate because the <code>#[const_eval_limit]</code> is reached would even be unsound,
as a different crate could raise that limit and would therefore consider the candidate to hold.</p>
<h3 id="possible-designs"><a class="header" href="#possible-designs">Possible designs</a></h3>
<p>We're going to refer to the initial example of this document.</p>
<h4 id="rely-on-errors-for-disjointness"><a class="header" href="#rely-on-errors-for-disjointness">Rely on errors for disjointness</a></h4>
<p>Do we want to consider impls for <code>[u8; N - 1]</code> and <code>[u8; 0]</code> to be disjoint by themselves?</p>
<p>Given that we have to silence the CTFE errors anyways, we could reject candidates if they contain a constant which fails to evaluate.
If we do this, the following change can break code:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// original version:
const fn my_computation(n: usize) -&gt; usize {
    if some_edge_case(n) {
        unimplemented!()
    } else {
        whatever(n)
    }
}
// updated version:
const fn my_computation(n: usize) -&gt; usize {
    if some_edge_case(n) {
        deal_with_edge_case(n)
    } else {
        whatever(n)
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>It generally seems desirable to not consider such a change to be breaking. Such a case actually causing issues seems quite unlikely,
though it definitely may happen that people write overlapping impls relying on <code>some_edge_case</code> precisely because <code>my_computation</code> panics in
that case.</p>
<h4 id="require-explicit-bounds"><a class="header" href="#require-explicit-bounds">Require explicit bounds</a></h4>
<p>We could also require a <code>Condition&lt;{ N &gt; 0 }&gt;: IsTrue</code> bound for this to compile,
potentially adding some syntactic sugar or special predicate for this.</p>
<p>This adds some additional boilerplate to impls, though it does reduce the
amount of implicit behavior the user has to understand. It also prevents any unintentional breakage
when fixing buggy functions which would cause them to terminate successfully instead of panicking.
For types like <code>[u8; N / 2 - 1]</code> the correct boolean condition to prevent this from panicking isn't immediately obvious however.
This could introduce some errors. To avoid these we could add a lint, recommending the correct boolean condition for a given computation where possible.</p>
<p>If a candidate contains a CTFE failure but would otherwise hold, we can either consider that candidate to be ambiguous or emit a hard
error. The exact impact of making candidates ambiguous isn't yet clear and needs further consideration.</p>
<h4 id="require-explicit-bounds-for-ctfe-failures-inside-of-functions"><a class="header" href="#require-explicit-bounds-for-ctfe-failures-inside-of-functions">Require explicit bounds for CTFE failures inside of functions</a></h4>
<p>Changing the body of a constant used in the type system will be a breaking change as it may can prevent unification.
It might therefore be sensible that errors originating directly in the anonymous constant - or transparent named constant - 
cause the candidate to be rejected while errors originating in functions - or opaque named constants - would require an explicit bound.</p>
<h2 id="status"><a class="header" href="#status">Status</a></h2>
<p><strong>Idle</strong>: We can already work on this but it's also fine to wait until <code>feature(generic_const_exprs)</code> is
closer to stable.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../design/const-eval-requirements.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../design/structural-equality.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../design/const-eval-requirements.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../design/structural-equality.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../viz.js"></script>
        <script type="text/javascript" src="../panzoom.min.js"></script>
        <script type="text/javascript" src="../full.render.js"></script>
        <script type="text/javascript" src="../skill-tree.js"></script>
    </body>
</html>
